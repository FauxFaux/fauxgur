<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
          crossorigin="anonymous">
    <title>Fauxgur</title>
    <style type="text/css">
        body {
            background-color: #222222;
            color: #ffffff;
        }

        img {
            max-width: 100%;
            max-height: 80vh;
        }

        a {
            padding-left: 1em
        }

        p {
            white-space: pre-wrap;
            font-size: 150%
        }

        hr {
            border: 0;
            border-top: 1px solid #eee;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        p.msg {
            width: 100%;
            text-align: center;
            font-size: 10em;
            padding: 1em;
        }

        p.msg p {
            font-size: 50%;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div id="b">
                <p class="msg">Loading scripts from CDN...</p>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script src="jquery.touchSwipe.min.js"
        integrity="sha256-89OKxKSNdqFaIJbiI2FxHA770JbBoovI4BPBGmuD4ks="
        crossorigin="anonymous"></script>
<script>
  var list = [];
  var cur = 0;
  var gal = 0;
  var browsing = undefined;
  $(function () {
    var args = window.location.hash.split('#');
    var lastid;
    if (3 === args.length) {
      if ('viral' === args[1]) {
        browsing = 'viral';
      } else if ('rising' === args[1]) {
        browsing = 'rising';
      } else {
        browsing = args[1];
        alert("invalid gallery");
      }

      lastid = args[2];
    }

    if (browsing) {
      load_gallery(browsing, lastid);
    } else {
      var status = $('#b p.msg');
      status.html("⇦ for chaos, ⇨ for order<p>Then, ⇦/⇨ prev/next page. ⇧/⇩ prev/next image in gallery.</p>");
    }
    function goLeft() {
      if (!browsing) {
        browsing = 'rising';
        load_gallery(browsing, undefined);
        return;
      }
      if (cur > 0) {
        cur--;
      }
      go(cur);
    }

    function goRight() {
      if (!browsing) {
        browsing = 'viral';
        load_gallery(browsing, undefined);
        return;
      }
      cur++;
      if (cur >= list.length) {
        cur = 0;
      }
      go(cur);
    }

    $(document).keydown(function (ev) {
      switch (ev.keyCode) {
        case 37: // left
          goLeft();
          return false;
        case 39: // right
          goRight();
          return false;
        case 40: //down
          gal++;
          $('#gal' + gal).get(0).scrollIntoView();
          return false;
        case 38: //up
          gal--;
          if (gal < 0) {
            gal = 0;
          }
          $('#gal' + gal).get(0).scrollIntoView();
          return false;
      }
    });
    $(document).swipe({
      swipeLeft: goLeft,
      swipeRight: goRight,
    });
  });

  function load_gallery(gal, lastid) {
    var status = $('#b p.msg');
    status.html("Loading gallery...");
    var urls = [];
    for (var i = 0; i < 5; ++i) {
      urls.push($.ajax(gal + '/' + i));
    }
    $.when.apply(this, urls).done(function () {
      var virals = Array.prototype.slice.call(arguments);
      for (var i = 0; i < virals.length; ++i) {
        Array.prototype.push.apply(list, virals[i][0].data);
      }

      for (var i = 0; i < list.length; ++i) {
        if (list[i].id === lastid) {
          cur = i;
          break;
        }
      }
      go(cur);
    }).fail(function () {
      status.html("Something went wrong, it's probably over capacity. Please refresh.");
    });
  }


  function img(link, id) {
    var href = link.replace('http:', 'https:');
    var a = $('<a/>', {
      href: href
    });
    $('<img/>', {
      src: link.replace('http:', 'https:'),
      id: id
    }).appendTo(a);
    return a;
  }

  function part(item, idx) {
    var space = Math.min($(window).width() / item.width, $(window).height() / item.height);
    var zoom = space > 5 ? 4 : (space > 2.5 ? 2 : 1);

    if (item.webm || item.mp4) {
      var vid = $('<video/>', {
        autoplay: 'autoplay',
        loop: 'loop',
        muted: 'muted',
        volume: 0,
        width: item.width,
        height: item.height,
        id: 'gal' + (idx + 1)
      })
        .css('zoom', zoom)
        .appendTo('#b');
      if (item.webm) {
        $('<source/>', {
          src: item.webm.replace('http:', 'https:'),
          type: 'video/webm'
        }).appendTo(vid);
      }
      if (item.mp4) {
        $('<source/>', {
          src: item.mp4.replace('http:', 'https:'),
          type: 'video/mp4'
        }).appendTo(vid);
      }
    } else {
      img(item.link, 'gal' + (idx + 1))
        .css('zoom', zoom)
        .appendTo('#b');

    }
    if (item.description) {
      $('<p/>').text(item.description).appendTo('#b');
    }

    $('<hr/>', {}).appendTo('#b');
  }

  var max = 30;

  function go(i) {
    gal = 0;
    var item = list[i];
    $('#b').empty();
    var h1 = $('<h1/>').text(item.title).appendTo('#b');
    $('<a/>', {
      href:
        item.is_album
          ? item.link.replace('http:', 'https:')
          : 'https://imgur.com/' + item.id
    }).text(item.id
      + (item.images_count > 2 ? ' (' + item.images_count + ')' : ''))
      .appendTo(h1);
    $('<a/>', {href: '/'}).text('/').appendTo(h1);

    if (!item.is_album) {
      part(item, 0);
    } else {
      var initial = item.images.length;
      for (var j = 0; j < initial; ++j) {
        part(item.images[j], j);
      }

      if (item.images_count > initial) {
        $.getJSON('album/' + item.id, function (album) {
          var images = album.data.images;
          for (var j = initial; j < Math.min(images.length, max); ++j) {
            part(images[j], j);
          }
        });
      }
    }

    history.pushState({}, item.title, '#' + browsing + '#' + item.id);

    function attempt_preload(item) {
      // TODO: totally yolo on the video preloading
      var link = item.mp4 || item.webm || item.link;
      $('<img/>', {src: link.replace('http:', 'https:')});
    }

    window.setTimeout(function () {
      var next = list[i + 1];
      if (next) {
        if (next.is_album) {
          if (item.images && item.images_count > item.images.length) {
            $.getJSON('album/' + next.id, function () {
            });
          }
          // loads the imgur approved pre-load list (3 images at time of writing)
          for (var imi = 0; imi < next.images.length; ++imi) {
            attempt_preload(next.images[imi]);
          }
        } else {
          attempt_preload(next);
        }
      }
    }, 100);
  }
</script>
</body>
</html>
