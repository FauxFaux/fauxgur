<!doctype html>
<html>
<head>
<title>Fauxgur</title>
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"/>
<style type="text/css">
body {
    background-color: #222222;
    color: #ffffff;
}
img {
    max-width: 100%;
    max-height: 80vh;
}
a {
    padding-left: 1em
}
p {
    white-space: pre-wrap;
    font-size: 150%
}
</style>
<script>
var list=[];
var cur=0;
var gal=0;
$(function() {
    var urls = [];
    for (var i = 0; i < 5; ++i) {
        urls.push($.ajax('viral/' + i));
    }
    $.when.apply(this, urls).done(function() {
        var virals = Array.prototype.slice.call(arguments);
        for (var i = 0; i < virals.length; ++i) {
            Array.prototype.push.apply(list, virals[i][0].data);
        }


        var lastid = window.location.hash.substring(1);
        for (var i = 0; i < list.length; ++i) {
            if (list[i].id == lastid) {
                cur = i;
                break;
            }
        }
        go(cur);
    });
    $(document).keydown(function(ev) {
        switch(ev.keyCode) {
            case 37: //left
                if (cur>0) {
                    cur--;
                }
                go(cur);
                return false;
            case 39: //right
                cur++;
                if (cur>=list.length) {
                    cur=0;
                }
                go(cur);
                return false;
            case 40: //down
                gal++;
                $('#gal' + gal).get(0).scrollIntoView();
                return false;
            case 38: //up
                gal--;
                if (gal<0) {
                    gal=0;
                }
                $('#gal' + gal).get(0).scrollIntoView();
                return false;
        }
    });
});

function img(link, id) {
    var href=link.replace('http:','https:');
    var a=$('<a/>', {
            href: href
            });
    $('<img/>', {
        src: link.replace('http:','https:'),
        id: id
    }).appendTo(a);
    return a;
}

function part(item, idx) {
    var space = Math.min($(window).width()/item.width, $(window).height()/item.height);
    var zoom = space > 5 ? 4 : (space > 2.5 ? 2 : 1);

    if (item.webm || item.mp4) {
        var vid = $('<video/>', {
                autoplay: 'autoplay',
                loop: 'loop',
                width: item.width,
                height: item.height,
                id: 'gal' + (idx+1)
                })
            .css('zoom', zoom)
            .appendTo('#b');
        if (item.webm) {
            $('<source/>', {
                src: item.webm.replace('http:', 'https:'),
                type: 'video/webm',
            }).appendTo(vid);
        }
        if (item.mp4) {
            $('<source/>', {
                src: item.mp4.replace('http:', 'https:'),
                type: 'video/mp4',
            }).appendTo(vid);
        }
    } else {
        img(item.link, 'gal' + (idx+1))
            .css('zoom', zoom)
            .appendTo('#b');

    }
    if (item.description) {
        $('<p/>').text(item.description).appendTo('#b');
    }

    $('<hr/>', {}).appendTo('#b');
}

var max = 30;

function go(i) {
    gal=0;
    var item = list[i];
    $('#b').empty();
    var h1 = $('<h1/>').text(item.title).appendTo('#b');
    $('<a/>', { href:
            item.is_album
                ? item.link.replace('http:', 'https:')
                : 'https://imgur.com/' + item.id }).text(item.id
        + (item.images_count > 2 ? ' (' + item.images_count + ')' : ''))
        .appendTo(h1);
    $('<a/>', { href: '/' }).text('/').appendTo(h1);

    if (!item.is_album) {
        part(item, 0);
    } else {
        $.getJSON('album/' + item.id, function(album) {
            var images = album.data.images;
            for (var j=0; j<Math.min(images.length, max); ++j) {
                part(images[j], j);
            }
        });
    }

    history.pushState({}, item.title, '#' + item.id);

    window.setTimeout(function() {
        var next = list[i+1];
        if (next && !next.is_album) {
            $('<img/>', { src: list[i+1].link.replace('http:', 'https:') });
        }
    }, 0);
}
</script>
</head>
<body>
<div class="container-fluid">
<div class="col-md-12">
<div id="b"/>
</div>
</div>
</body>
</html>
